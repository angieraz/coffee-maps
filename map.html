<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>–ö–∞—Ä—Ç–∞ –∑ –∫–∞–≤‚Äô—è—Ä–Ω—è–º–∏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="styles.css">
  <link href="https://fonts.googleapis.com/css2?family=WDXL+Lubrifont+TC&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles2.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>

  <div class="headerContainer">
    <div onclick="toggleMenu()">
      <h1 class="header">CoffeeMaps.</i></h1> <!-- <i class="fa-solid fa-mug-hot"> -->
    </div>
      <div class="profile">
        <i class="fa-solid fa-circle-user"></i>
      </div>
  </div>

    <!-- –ø—Ä–æ—Ñ—ñ–ª—å -->
  <div id="profileModal" class="modal hidden">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal()">&times;</span>
      <i class="fa-solid fa-circle-user profile-icon"></i>
      <h2 class="username">–ì—ñ—Å—Ç—å</h2>
      <div class="modal-buttons">
        <button onclick="register()">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—å</button>
        <p class="login-text">–í–∂–µ –º–∞—î—à –ø—Ä–æ—Ñ—ñ–ª—å? <a href="#" onclick="login()">–£–≤—ñ–π—Ç–∏</a></p>
      </div>
    </div>
  </div>

    <!-- –ª–æ–≥—ñ–Ω -->
  <div id="loginModal" class="modal hidden">
    <div class="modal-content">
      <span class="close-btn" onclick="closeLogin()">&times;</span>
      <h2>–£–≤—ñ–π—Ç–∏</h2>
      <form onsubmit="submitLogin(event)">
        <input type="email" id="loginEmail" placeholder="Email" name="email" required>
        <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å" name="password" required>
        <div id="loginError" class="error_msg"></div>
        <button type="submit">–£–≤—ñ–π—Ç–∏</button>
        <p class="login-text">–í–ø–µ—Ä—à–µ —Ç—É—Ç? <a href="#" onclick="register()">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</a></p>
        <form onsubmit="submitLogin(event)">
      </form>
    </div>
  </div>

  <!-- —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è -->
  <div id="registerModal" class="modal hidden">
    <div class="modal-content">
      <span class="close-btn" onclick="closeRegister()">&times;</span>
      <h2>–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</h2>
      <form onsubmit="submitRegister(event)">
        <input type="text" placeholder="–Ü–º'—è" name="firstName" required>
        <input type="text" placeholder="–ü—Ä—ñ–∑–≤–∏—â–µ" name="lastName" required>
        <input type="email" placeholder="Email" name="email" required>
        <input type="password" placeholder="–ü–∞—Ä–æ–ª—å" name="password" required>
        <div id="registerError" class="error_msg"></div>
        <button type="submit">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—å</button>
        <p class="login-text">–í–∂–µ –º–∞—î—à –ø—Ä–æ—Ñ—ñ–ª—å? <a href="#" onclick="login()">–£–≤—ñ–π—Ç–∏</a></p>
      </form>
    </div>
  </div>


  <label>
      <input type="checkbox" class="variant" id="menu-toggle">
        <div class="toggle">
            <span class="top_line common"></span>
            <span class="middle_line common"></span>
            <span class="bottom_line common"></span>
        </div>
        <div class="slide">
            <h1 class="menu">MENU</h1>
            <ul>
                <li><a href="#"><i class="fas fa-map-marked-alt"></i>–í—ñ–¥–∫—Ä–∏—Ç—ñ –∫–∞–≤'—è—Ä–Ω—ñ</a></li>
                <li><a href="#" onclick="showMyReviews()"><i class="fas fa-comments"></i> –í—Å—ñ –≤—ñ–¥–≥—É–∫–∏</a></li>
                <li><a href="#"><i class="fa-solid fa-medal"></i>–ù–∞–≥–æ—Ä–æ–¥–∏</a></li>
                <li><a href="#"><i class="fas fa-cogs"></i>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</a></li> <!--- –∑–º—ñ–Ω–∞ –º–æ–≤–∏, —Ç–µ–º–Ω–∞ —Ç–µ–º–∞ —Ç–æ—â–æ -->
                <li><a href="#"><i class="fas fa-info-circle"></i>–ü—Ä–æ CofeeMaps</a></li>
                <li class="menu-divider"></li> <!-- –†–æ–∑–¥—ñ–ª—å–Ω–∏–∫ -->
                <div id="panel-content" class="review-panel"></div>

            </ul>
        </div>
  </label>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
  function toggleMenu() {
    const checkbox = document.getElementById("menu-toggle");
    checkbox.checked = !checkbox.checked;
  }
</script>

<script>
    const dropdownBtns = document.querySelectorAll('.dropdown-btn');

    dropdownBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const subMenu = btn.nextElementSibling;
            subMenu.classList.toggle('show');
        });
    });
</script>


<script>
  
  // 1. –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ —Ü–µ–Ω—Ç—Ä—É –õ—å–≤–æ–≤–∞
  const centerLviv = [49.8398, 24.0309];

  // 2. –ú–µ–∂—ñ –æ–±–ª–∞—Å—Ç—ñ (bounds) ‚Äî –º–æ–∂–Ω–∞ —Ç—Ä–æ—Ö–∏ —à–∏—Ä—à–µ –º—ñ—Å—Ç–∞
  const boundsLviv = L.latLngBounds(
  [49.82170, 23.99998],  // –ø—ñ–≤–¥–µ–Ω–Ω–æ-–∑–∞—Ö—ñ–¥–Ω–∏–π –∫—É—Ç
  [49.85791, 24.06195]  // –ø—ñ–≤–Ω—ñ—á–Ω–æ-—Å—Ö—ñ–¥–Ω–∏–π –∫—É—Ç
  );

  // 3. –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∫–∞—Ä—Ç–∏
  const map = L.map('map', {
    center: centerLviv,
    zoom: 13,
    maxBounds: boundsLviv,         // –æ–±–º–µ–∂–µ–Ω–Ω—è –æ–±–ª–∞—Å—Ç—ñ
    maxBoundsViscosity: 1.0        // –Ω–µ –¥–æ–∑–≤–æ–ª—è—î –≤–∏—Ö–æ–¥–∏—Ç–∏ –∑–∞ –º–µ–∂—ñ
  });

  // 4. –û–±–º–µ–∂–µ–Ω–Ω—è –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è
  map.setMinZoom(18); // –º—ñ–Ω—ñ–º–∞–ª—å–Ω–æ –¥–æ–∑–≤–æ–ª–µ–Ω–∏–π –∑—É–º 16 –ó–ú–Ü–ù–ò–¢–ò –ü–û–¢–Ü–ú
  map.setMaxZoom(19); // –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ–∑–≤–æ–ª–µ–Ω–∏–π –∑—É–º

  L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; OpenStreetMap contributors & CartoDB',
    subdomains: 'abcd',
    maxZoom: 20
  }).addTo(map);

  // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–∞–≤‚Äô—è—Ä–µ–Ω—å —ñ–∑ Overpass API
  const overpassUrl = 'https://overpass-api.de/api/interpreter?data=[out:json];node["amenity"="cafe"](49.80,24.00,49.87,24.08);out;';

 /* fetch(overpassUrl)
    .then(response => response.json())
    .then(data => {
      data.elements.forEach(cafe => {
        const marker = L.marker([cafe.lat, cafe.lon]).addTo(map);
        const name = cafe.tags && cafe.tags.name ? cafe.tags.name : '–ö–∞–≤‚Äô—è—Ä–Ω—è';
        marker.bindPopup(`<b>${name}</b>`);
      });
    })
    .catch(err => console.error('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ:', err));
*/

</script>

<script>
  const profileIcon = document.querySelector('.profile i');
  const profileModal = document.getElementById('profileModal');

  profileIcon.addEventListener('click', () => {
    profileModal.classList.remove('hidden');
  });

  function closeModal() {
    profileModal.classList.add('hidden');
  }

  window.addEventListener('click', function(event) {
    if (event.target === profileModal) {
      closeModal();
    }
  });

  function login() {
  document.getElementById("loginModal").classList.remove("hidden");
  closeRegister();
  closeModal();
}

function register() {
  document.getElementById("registerModal").classList.remove("hidden");
  closeLogin();
  closeModal();
}

function closeModal() {
  document.getElementById("profileModal").classList.add("hidden");
}

function closeLogin() {
  document.getElementById("loginModal").classList.add("hidden");
}

function closeRegister() {
  document.getElementById("registerModal").classList.add("hidden");
}

// –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è
async function submitLogin(event) {
  event.preventDefault();
  const email = document.getElementById("loginEmail").value;
  const password = document.getElementById("loginPassword").value;

  try {
    const res = await fetch("http://localhost:8080/api/auth", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password })
    });

    const data = await res.json();

    if (!res.ok) {
      alert(data.message);
      return;
    }

    localStorage.setItem("token", data.token);
    localStorage.setItem("user", JSON.stringify(data.user));

    location.href = "map.html";
  } catch (err) {
    alert("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥—ñ");
  }
}


// –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è
async function submitRegister(event) {
  event.preventDefault();
  const form = event.target;
  const firstName = form.firstName.value;
  const lastName = form.lastName.value;
  const email = form.email.value;
  const password = form.password.value;
  const errorBox = document.getElementById("registerError");
  errorBox.textContent = "";

  try {
    const res = await fetch("http://localhost:8080/api/users", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ firstName, lastName, email, password }),
    });

    const data = await res.json();

    if (!res.ok) throw new Error(data.message);
    alert("–£—Å–ø—ñ—à–Ω–æ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ! –£–≤—ñ–π–¥—ñ—Ç—å —É —Å–∏—Å—Ç–µ–º—É.");
    closeRegister();
    login();
  } catch (error) {
    errorBox.textContent = error.message;
  }
}

function getUserFromToken() {
  const token = localStorage.getItem("token");
  if (!token) return null;

  const payload = JSON.parse(atob(token.split(".")[1]));
  return {
    firstName: payload.firstName,
    lastName: payload.lastName,
    email: payload.email,
  };
}

function getUserFromStorage() {
  const userStr = localStorage.getItem("user");
  return userStr ? JSON.parse(userStr) : null;
}

function updateProfileUI() {
  const user = getUserFromStorage(); // –∞–±–æ getUserFromToken() —è–∫—â–æ —Ç–æ–∫–µ–Ω –º—ñ—Å—Ç–∏—Ç—å –¥–∞–Ω—ñ
  const usernameElem = document.querySelector(".username");
  const modalButtons = document.querySelector(".modal-buttons");

  if (user) {
    usernameElem.textContent = `${user.firstName} ${user.lastName}`;
    modalButtons.innerHTML = `<button onclick="logout()">–í–∏–π—Ç–∏</button>`;
  } else {
    usernameElem.textContent = "–ì—ñ—Å—Ç—å";
    modalButtons.innerHTML = `
      <button onclick="register()">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—å</button>
      <p class="login-text">–í–∂–µ –º–∞—î—à –ø—Ä–æ—Ñ—ñ–ª—å? <a href="#" onclick="login()">–£–≤—ñ–π—Ç–∏</a></p>
    `;
  }
}

function logout() {
  localStorage.removeItem("token");
  localStorage.removeItem("user");
	location.reload();
  updateProfileUI();
}

document.addEventListener("DOMContentLoaded", () => {
  updateProfileUI();
});

function openModal() {
	const modal = document.getElementById("profileModal");
	const usernameEl = modal.querySelector(".username");

	const userStr = localStorage.getItem("user");
	if (userStr) {
		const user = JSON.parse(userStr);
		usernameEl.textContent = `${user.firstName} ${user.lastName}`;
		
		const buttonsDiv = modal.querySelector(".modal-buttons");
		buttonsDiv.innerHTML = `
			<button onclick="logout()">–í–∏–π—Ç–∏</button>
		`;
	} else {
		usernameEl.textContent = "–ì—ñ—Å—Ç—å";
	}

	modal.classList.remove("hidden");
}

</script>

<script>
  const cafeReviews = {}; // –∫–ª—é—á: lat+lng, –∑–Ω–∞—á–µ–Ω–Ω—è: –º–∞—Å–∏–≤ –≤—ñ–¥–≥—É–∫—ñ–≤
  const cafeMarkers = [];
  const revealSound = new Audio('found.mp3');
  revealSound.volume = 0.8; // —Ç–∏—à–∞ –¥–æ –≥—É—á–Ω–æ–≥–æ ‚Äî –≤—ñ–¥ 0.0 –¥–æ 1.0

fetch(overpassUrl)
  .then(response => response.json())
  .then(data => {
    data.elements.forEach(cafe => {
      const latlng = [cafe.lat, cafe.lon];
      const name = cafe.tags && cafe.tags.name ? cafe.tags.name : '–ö–∞–≤‚Äô—è—Ä–Ω—è';
      const id = cafe.id;

      const hiddenIcon = L.icon({
        iconUrl: 'question-mark3.png',
        iconSize: [30, 30],
        iconAnchor: [15, 30],
        popupAnchor: [0, -25]
      });

      const marker = L.marker(latlng, { icon: hiddenIcon }).addTo(map);
      cafeMarkers.push({ id, marker, latlng, name, revealed: false });
    });
  })
  .catch(error => console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –∫–∞–≤‚Äô—è—Ä–µ–Ω—å:", error));

  const token = localStorage.getItem("token");
  const fogLayer = L.layerGroup().addTo(map);
  const fogTiles = []; // –∫–æ–∂–Ω–∞ –ø–ª–∏—Ç–∫–∞-—Ç—É–º–∞–Ω
  const tileSize = 0.0005; // —Ä–æ–∑–º—ñ—Ä –ø—Ä—è–º–æ–∫—É—Ç–Ω–∏–∫–∞ 0.0005

  let revealedAreas = [];
  
function escapeHtml(text) {
  const div = document.createElement('div');
  div.innerText = text;
  return div.innerHTML;
}

function getAverageRating(cafeId) {
  const token = localStorage.getItem("token");
  const isGuest = !token || token === "0";

  let reviews = cafeReviews[cafeId] || [];

  // ‚õîÔ∏è –ì—ñ—Å—Ç—å: –¥–æ–¥–∞—î–º–æ –≥–æ—Å—Ç—å–æ–≤—ñ –≤—ñ–¥–≥—É–∫–∏ –∑ sessionStorage
  if (isGuest) {
    const localReviewsData = JSON.parse(sessionStorage.getItem("localReviews")) || {};
    const guestReviews = localReviewsData[cafeId] || [];
    reviews = reviews.concat(guestReviews);
  }

  if (reviews.length === 0) return '–ù–µ–º–∞—î –æ—Ü—ñ–Ω–æ–∫';

  const avg = reviews.reduce((sum, r) => sum + r.rating, 0) / reviews.length;
  return avg.toFixed(1) + ' / 5';
}

function openReviewForm(id) {
  document.getElementById(`form-${id}`).style.display = 'block';
}

async function fetchCafeReviews(cafeId) {
  const token = localStorage.getItem("token");
  if (!token || token === "0") {
    console.warn("–ì—ñ—Å—Ç—å –Ω–µ –º–æ–∂–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å–µ—Ä–≤–µ—Ä–Ω—ñ –≤—ñ–¥–≥—É–∫–∏.");
    return [];
  }

  try {
    const res = await fetch(`http://localhost:8080/api/reviews/${cafeId}`, {
      headers: {
        Authorization: `Bearer ${token}`
      }
    });

    if (!res.ok) throw new Error("–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –≤—ñ–¥–≥—É–∫–∏");

    const data = await res.json();

    // –û–Ω–æ–≤–∏—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–∏–π –∫–µ—à
    cafeReviews[cafeId] = data.map(r => ({
      rating: r.rating,
      comment: r.comment
    }));

    return cafeReviews[cafeId];

  } catch (err) {
    console.error("‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –≤—ñ–¥–≥—É–∫—ñ–≤:", err.message);
    return [];
  }
}

function submitReview(id, lat, lng) {
  const ratingEls = document.getElementsByName(`rating-${id}`);
  let rating = 0;
  for (const r of ratingEls) {
    if (r.checked) rating = parseInt(r.value);
  }

  let comment = document.getElementById(`comment-${id}`).value;

  if (rating === 0) {
    alert("–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å –æ—Ü—ñ–Ω–∫—É.");
    return;
  }

  if (comment.trim() === '') {
    comment = '–ë–µ–∑ –∫–æ–º–µ–Ω—Ç–∞—Ä—è.';
  }

  const token = localStorage.getItem("token");

  function cleanupForm() {
    for (const r of ratingEls) r.checked = false;
    document.getElementById(`comment-${id}`).value = "";
    const form = document.getElementById(`form-${id}`);
    if (form) form.style.display = "none";

const cafe = cafeMarkers.find(c => c.latlng[0] === lat && c.latlng[1] === lng);
    if (cafe) {
      const avgRating = getAverageRating(id);
      const marker = cafe.marker;
      const name = cafe.name;

      marker.setPopupContent(`
        <div class="center-name"><b class="popup-name">${name}</b><br></div>
        ‚≠ê ${avgRating}<br> 
        <button class="popup-btn" onclick="openReviewForm('${id}')">–ó–∞–ª–∏—à–∏—Ç–∏ –≤—ñ–¥–≥—É–∫</button> 
        <button class="popup-btn" onclick="showCafeReviews('${id}')">–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –≤—ñ–¥–≥—É–∫–∏</button> 

        <div id="form-${id}" class="popup-form">
          <label>–û—Ü—ñ–Ω–∫–∞:</label><br> 
          ${[1, 2, 3, 4, 5].map(star => `
            <label class="star-label">
              <input type="radio" name="rating-${id}" value="${star}">
              ${star} ‚≠ê
            </label>
          `).join('')}<br> 

          <textarea id="comment-${id}" class="popup-textarea" placeholder="–í–∞—à –≤—ñ–¥–≥—É–∫..."></textarea><br> 
          <div class="center-btn"><button class="popup-btn" onclick="submitReview('${id}', ${lat}, ${lng})">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button></div> 
        </div> 
      `);
    }
  }

  if (!token || token === "0") {
    // üë§ –ì—ñ—Å—Ç—å ‚Äî –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –ª–∏—à–µ –≤ sessionStorage
    const localReviews = JSON.parse(sessionStorage.getItem("localReviews")) || {};
    if (!localReviews[id]) localReviews[id] = [];
    localReviews[id].push({ rating, comment, date: new Date().toISOString() });
    sessionStorage.setItem("localReviews", JSON.stringify(localReviews));

    alert("–í–∞—à –≤—ñ–¥–≥—É–∫ –∑–±–µ—Ä–µ–∂–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ (–≤–∏ –Ω–µ —É–≤—ñ–π—à–ª–∏ –≤ —Å–∏—Å—Ç–µ–º—É)");
    cleanupForm();
    return;
  }

  // ‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á ‚Äî –Ω–∞–¥—Å–∏–ª–∞—î–º–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
  fetch("http://localhost:8080/api/reviews", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + token
    },
    body: JSON.stringify({
      cafeId: id,
      rating: rating,
      comment: comment
    })
  })
    .then(res => {
      if (!res.ok) throw new Error('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è');
      return res.json();
    })
    .then(() => {
      alert("–î—è–∫—É—î–º–æ –∑–∞ –≤—ñ–¥–≥—É–∫!");
      if (!cafeReviews[id]) cafeReviews[id] = [];
      cafeReviews[id].push({ rating, comment }); // –ª–∏—à–µ —Å–µ—Ä–≤–µ—Ä–Ω–∏–π
      cleanupForm();
    })
    .catch(err => {
      alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏ –≤—ñ–¥–≥—É–∫: " + err.message);
    });

  console.log("Token:", token);
}

function showCafeReviews(cafeId) {
  const token = localStorage.getItem("token");
  const isGuest = !token || token === "0";

  // ‚õîÔ∏è –ì—ñ—Å—Ç—å: –±–∞—á–∏—Ç—å –ª–∏—à–µ –≤–ª–∞—Å–Ω—ñ –≤—ñ–¥–≥—É–∫–∏ –∑ sessionStorage
  if (isGuest) {
    const localReviewsData = JSON.parse(sessionStorage.getItem("localReviews")) || {};
    const localReviews = localReviewsData[cafeId] || [];
    renderReviewsHtml(cafeId, localReviews); // ‚ùóÔ∏è –ù–ï –≤–∫–ª—é—á–∞—î —Å–µ—Ä–≤–µ—Ä–Ω—ñ
    return;
  }

  // ‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏–π: –æ—Ç—Ä–∏–º—É—î –≤—ñ–¥–≥—É–∫–∏ –∑ —Å–µ—Ä–≤–µ—Ä–∞
  fetch(`http://localhost:8080/api/reviews/${cafeId}`, {
    headers: {
      Authorization: `Bearer ${token}`
    }
  })
    .then(res => {
      if (!res.ok) throw new Error("–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –≤—ñ–¥–≥—É–∫–∏");
      return res.json();
    })
    .then(data => {
      // –û–Ω–æ–≤–∏—Ç–∏ –∫–µ—à –ª–∏—à–µ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏—Ö
      cafeReviews[cafeId] = data.map(r => ({
        rating: r.rating,
        comment: r.comment
      }));

      renderReviewsHtml(cafeId, cafeReviews[cafeId]);
    })
    .catch(err => {
      alert("‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –≤—ñ–¥–≥—É–∫—ñ–≤: " + err.message);
    });
}

function renderReviewsHtml(cafeId, allReviews) {
  const cafe = cafeMarkers.find(c => c.id === parseInt(cafeId));
  const cafeName = cafe ? cafe.name : '–ö–∞–≤‚Äô—è—Ä–Ω—è';

  let html = `<h4>–í—ñ–¥–≥—É–∫–∏ –¥–ª—è –∫–∞–≤'—è—Ä–Ω—ñ <br> "<i>${escapeHtml(cafeName)}</i>"</h4>`;

  if (allReviews.length === 0) {
    html += "<p>–ù–µ–º–∞—î –≤—ñ–¥–≥—É–∫—ñ–≤ –¥–ª—è —Ü—ñ—î—ó –∫–∞–≤'—è—Ä–Ω—ñ.</p>";
  } else {
    html += "<ul>";
    allReviews.forEach((r, i) => {
      const isGuest = r.date ? ' <i>(–≥–æ—Å—Ç—å–æ–≤–∏–π)</i>' : '';
      html += `<li>${i + 1}) ${r.rating} ‚≠ê ‚Äî ${escapeHtml(r.comment)}${isGuest}</li>`;
    });
    html += "</ul>";
  }

  document.getElementById("panel-content").innerHTML = html;

  const checkbox = document.querySelector("input[type='checkbox']");
  if (checkbox) checkbox.checked = true;
}

function showMyReviews() {
  const token = localStorage.getItem("token");
  if (!token || token === "0") {
    alert("‚ùå –õ–∏—à–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –º–æ–∂—É—Ç—å –ø–µ—Ä–µ–≥–ª—è–¥–∞—Ç–∏ —Å–≤–æ—ó –≤—ñ–¥–≥—É–∫–∏.");
    return;
  }

  fetch("http://localhost:8080/api/reviews/", {
    headers: {
      Authorization: `Bearer ${token}`
    }
  })
    .then(res => {
      if (!res.ok) throw new Error("–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –≤–∞—à—ñ –≤—ñ–¥–≥—É–∫–∏.");
      return res.json();
    })
    .then(reviews => {
      let html = `<h4>–í—Å—ñ –≤–∞—à—ñ –≤—ñ–¥–≥—É–∫–∏</h4>`;

      if (reviews.length === 0) {
        html += "<p>–í–∏ —â–µ –Ω–µ –∑–∞–ª–∏—à–∞–ª–∏ –≤—ñ–¥–≥—É–∫—ñ–≤.</p>";
      } else {
        html += "<ul>";
        reviews.forEach((r, i) => {
          const cafeName = r.cafeId?.name || "–Ω–µ–≤—ñ–¥–æ–º–∞ –∫–∞–≤‚Äô—è—Ä–Ω—è";
          html += `<li>${i + 1}) <b>${escapeHtml(cafeName)}</b>: ${r.rating} ‚≠ê ‚Äî ${escapeHtml(r.comment)}</li>`;
        });
        html += "</ul>";
      }

      document.getElementById("panel-content").innerHTML = html;
    })
    .catch(err => {
      console.error(err);
      alert("‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –≤—ñ–¥–≥—É–∫—ñ–≤: " + err.message);
    });
}

// –§—É–Ω–∫—Ü—ñ—è, —â–æ –æ–Ω–æ–≤–ª—é—î revealedAreas —ñ –≤—ñ–¥—Å–∏–ª–∞—î –Ω–∞ —Å–µ—Ä–≤–µ—Ä
async function saveRevealedAreas() {
  const token = localStorage.getItem("token");
  if (!token) return; // –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ñ - –Ω–µ –∑–±–µ—Ä—ñ–≥–∞—î–º–æ

  console.log("revealedAreas:", revealedAreas);

  try {
    const res = await fetch("http://localhost:8080/api/explored", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`
      },
      body: JSON.stringify({ coordinates: revealedAreas })
    });
    if (!res.ok) throw new Error("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏ –≤—ñ–¥–∫—Ä–∏—Ç—ñ —Ç–µ—Ä–∏—Ç–æ—Ä—ñ—ó");
  } catch (err) {
    console.error(err);
  }
}

async function revealArea(lat, lng, areaRevealedRadius = 30, iconRevealRadius = 10) {
  const center = L.latLng(lat, lng);

  // –í—ñ–¥–∫—Ä–∏—Ç—Ç—è —Ç—É–º–∞–Ω—É (–∑–∞–ª–∏—à–∏–º–æ —è–∫ —î)
  fogTiles.forEach((rect) => {
    const bounds = L.latLngBounds(rect._fogBounds);
    const centerRect = bounds.getCenter();

    if (center.distanceTo(centerRect) < areaRevealedRadius && fogLayer.hasLayer(rect)) {
      let opacity = 0.8;
      const fade = setInterval(() => {
        opacity -= 0.1;
        if (opacity <= 0) {
          fogLayer.removeLayer(rect);
          clearInterval(fade);
        } else {
          rect.setStyle({ fillOpacity: opacity });
        }
      }, 50);

      // –î–æ–¥–∞—î–º–æ –≤—ñ–¥–∫—Ä–∏—Ç—É –ø–ª–∏—Ç–∫—É —É revealedAreas, —è–∫—â–æ —â–µ –Ω–µ–º–∞—î
      const exists = revealedAreas.some(pos => pos.lat === centerRect.lat && pos.lng === centerRect.lng);
      if (!exists) {
        revealedAreas.push({ lat: centerRect.lat, lng: centerRect.lng });
        saveRevealedAreas(); // –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ
      }
    }
  });

  // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–∞–≤'—è—Ä–µ–Ω—å
  for (const obj of cafeMarkers) {
    const dist = center.distanceTo(L.latLng(obj.latlng));
    if (dist < iconRevealRadius && !obj.revealed) {
      obj.revealed = true;
      const cafeId = obj.id;
      const name = obj.name;

      obj.marker.setIcon(L.icon({
        iconUrl: 'coffee-cup.png',
        iconSize: [25, 25],
        iconAnchor: [12, 25],
        popupAnchor: [0, -20]
      }));

      // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –≤—ñ–¥–≥—É–∫–∏, —è–∫—â–æ —â–µ –Ω–µ–º–∞—î
      if (!cafeReviews[cafeId] || cafeReviews[cafeId].length === 0) {
        try {
          const res = await fetch(`http://localhost:8080/api/reviews/${cafeId}`);
          if (!res.ok) throw new Error('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –≤—ñ–¥–≥—É–∫–∏');
          const data = await res.json();
          cafeReviews[cafeId] = data.map(r => ({ rating: r.rating, comment: r.comment }));
        } catch (err) {
          console.error("–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –≤—ñ–¥–≥—É–∫—ñ–≤ –∑ –±–∞–∑–∏:", err);
          cafeReviews[cafeId] = [];
        }
      }

      // –¢–µ–ø–µ—Ä —Ä–∞—Ö—É—î–º–æ —Å–µ—Ä–µ–¥–Ω—ñ–π —Ä–µ–π—Ç–∏–Ω–≥
      const avgRating = getAverageRating(cafeId);

      const popupContent = `
        <div class="center-name"><b class="popup-name">${name}</b><br></div>
        ‚≠ê ${avgRating}<br> 
        <button class="popup-btn" onclick="openReviewForm('${cafeId}')">–ó–∞–ª–∏—à–∏—Ç–∏ –≤—ñ–¥–≥—É–∫</button> 
        <button class="popup-btn" onclick="showCafeReviews('${cafeId}')">–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –≤—ñ–¥–≥—É–∫–∏</button> 
        
        <div id="form-${cafeId}" class="popup-form">
          <label>–û—Ü—ñ–Ω–∫–∞:</label><br> 
          ${[1, 2, 3, 4, 5].map(star => `
            <label class="star-label">
              <input type="radio" name="rating-${cafeId}" value="${star}">
              ${star} ‚≠ê
            </label>
          `).join('')}<br> 
          
          <textarea id="comment-${cafeId}" class="popup-textarea" placeholder="–í–∞—à –≤—ñ–¥–≥—É–∫..."></textarea><br> 
          <div class="center-btn"><button class="popup-btn" onclick="submitReview('${cafeId}', ${obj.latlng[0]}, ${obj.latlng[1]})">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button></div> 
        </div> 
      `;

      obj.marker.bindPopup(popupContent).openPopup();
      revealSound.currentTime = 0;
      revealSound.play();
    }
  }
}

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –≤—ñ–¥–∫—Ä–∏—Ç–∏—Ö –ø–ª–∏—Ç–æ–∫ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –∫–∞—Ä—Ç–∏
async function loadRevealedAreas() {
  const token = localStorage.getItem("token");
  if (!token) return;

  try {
    const res = await fetch("http://localhost:8080/api/explored", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${token}`
    },
    body: JSON.stringify({ coordinates: revealedAreas })
    });

    if (!res.ok) throw new Error("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≤—ñ–¥–∫—Ä–∏—Ç—ñ —Ç–µ—Ä–∏—Ç–æ—Ä—ñ—ó");
    const data = await res.json();

    if (data && data.coordinates) {
      revealedAreas = data.coordinates;

      // –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ —Ç—É–º–∞–Ω –¥–ª—è —Ü–∏—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
      revealedAreas.forEach(({ lat, lng }) => {
        fogTiles.forEach((rect) => {
          const bounds = L.latLngBounds(rect._fogBounds);
          const centerRect = bounds.getCenter();
          if (centerRect.lat === lat && centerRect.lng === lng && fogLayer.hasLayer(rect)) {
            fogLayer.removeLayer(rect);
          }
        });
      });
    }
  } catch (err) {
    console.error(err);
  }
}

// –í–∏–∫–ª–∏–∫ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó –∫–∞—Ä—Ç–∏
loadRevealedAreas();

function createFogOverlay() {
  const bounds = boundsLviv;

  for (let lat = bounds.getSouth(); lat < bounds.getNorth(); lat += tileSize) {
    for (let lng = bounds.getWest(); lng < bounds.getEast(); lng += tileSize) {
      const rectBounds = [
        [lat, lng],
        [lat + tileSize, lng + tileSize]
      ];

      const fogImage = L.imageOverlay('night-sky.gif', rectBounds, {
        opacity: 1,
        interactive: false,
        className: 'fog-tile'
      });

      fogImage._fogBounds = rectBounds; // –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∑ player'–æ–º
      fogLayer.addLayer(fogImage);
      fogTiles.push(fogImage);
    }
  }
}

createFogOverlay();
</script>

<script>
  // 1. –ü–æ—á–∞—Ç–∫–æ–≤–∞ –ø–æ–∑–∏—Ü—ñ—è "–≥—Ä–∞–≤—Ü—è"
  let playerPos = L.latLng(centerLviv); // 49.8398, 24.0309

  // 2. –î–æ–¥–∞—î–º–æ —Å–∏–Ω—ñ–π –∫—Ä—É–∂–µ—á–æ–∫-–≥—Ä–∞–≤—Ü—è
  const playerMarker = L.circleMarker(playerPos, {
    radius: 6,
    color: '#3388ff',
    fillColor: '#3388ff',
    fillOpacity: 1
  }).addTo(map);

  // 3. –§—É–Ω–∫—Ü—ñ—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ–∑–∏—Ü—ñ—ó
  function updatePlayerPosition(newLatLng) {
    playerPos = newLatLng;
    playerMarker.setLatLng(playerPos);
    map.panTo(playerPos); // –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–µ—Ä–µ–º—ñ—â–∞—î –∫–∞—Ä—Ç—É
    revealArea(playerPos.lat, playerPos.lng, 30, 10); // –≤—ñ–¥–∫—Ä–∏–≤–∞—î "—Ç—É–º–∞–Ω"
  }

  // 4. –†—É—Ö –ø–æ –∫–ª–∞–≤—ñ—à–∞—Ö
  document.addEventListener('keydown', function (e) {
    const step = 0.00005; // –º–µ–Ω—à–µ ‚Äî –ø–æ–≤—ñ–ª—å–Ω—ñ—à–µ

    let lat = playerPos.lat;
    let lng = playerPos.lng;

    if (e.key === 'ArrowUp') lat += step;
    if (e.key === 'ArrowDown') lat -= step;
    if (e.key === 'ArrowLeft') lng -= step;
    if (e.key === 'ArrowRight') lng += step;

    const newLatLng = L.latLng(lat, lng);

    // –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –º–µ–∂ –∫–∞—Ä—Ç–∏
    if (boundsLviv.contains(newLatLng)) {
      updatePlayerPosition(newLatLng);
    }
  });

  // 5. –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –∑–æ–Ω—É –Ω–∞ –ø–æ—á–∞—Ç–∫—É
  revealArea(playerPos.lat, playerPos.lng, 50, 10);
</script>

</body>
</html>
